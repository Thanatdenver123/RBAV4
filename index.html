<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RBA - ‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏≠‡∏ö‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Sarabun:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    
    <style>
        body { font-family: 'Sarabun', 'Inter', sans-serif; background-color: #f3f4f6; }
        .page { display: none; animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Interactive Grid */
        .cell-empty { background-color: #f3f4f6; }
        .cell-doing { background-color: #fbbf24; color: white; } /* Yellow (Current) */
        .cell-done { background-color: #94a3b8; color: white; } /* Gray (Done/Hidden) */
        .cell-correct { background-color: #22c55e; color: white; } /* Green */
        .cell-wrong { background-color: #ef4444; color: white; } /* Red */

        /* Toggle Switch */
        .toggle-checkbox:checked { right: 0; border-color: #68D391; }
        .toggle-checkbox:checked + .toggle-label { background-color: #68D391; }
        
        /* Loading */
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.95); z-index: 9999;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
        }
        .spinner { border: 4px solid #e5e7eb; border-top: 4px solid #3b82f6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Modal */
        #message-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6); z-index: 10000;
            display: none; justify-content: center; align-items: center;
        }
    </style>
</head>
<body class="text-gray-800">

    <div id="app" class="w-full max-w-6xl mx-auto p-4 min-h-screen flex flex-col">

        <!-- Loading -->
        <div id="loading-overlay">
            <div class="spinner mb-4"></div>
            <p class="text-gray-600 font-medium">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...</p>
            <p class="text-xs text-gray-400 mt-2">v4.0 Realtime</p>
        </div>
        
        <!-- Modal -->
        <div id="message-modal">
            <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md text-center mx-4">
                <div id="modal-icon" class="text-4xl mb-4">‚ö†Ô∏è</div>
                <h3 id="modal-title" class="text-xl font-bold mb-2">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</h3>
                <p id="modal-message" class="text-gray-600 mb-6 text-sm"></p>
                <button id="modal-close-btn" class="w-full bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">‡∏ï‡∏Å‡∏•‡∏á</button>
            </div>
        </div>

        <!-- 1. Home -->
        <div id="page-home" class="page m-auto bg-white p-8 rounded-xl shadow-lg text-center max-w-2xl w-full mt-10">
            <h1 class="text-3xl font-bold text-blue-700 mb-2">RBA Online Exam</h1>
            <p class="text-gray-500 mb-8">‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≠‡∏ö‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡πÅ‡∏ö‡∏ö Real-time Interactive</p>
            <div class="flex flex-col sm:flex-row gap-4 justify-center">
                <button id="btn-go-teacher" class="bg-blue-600 text-white px-8 py-3 rounded-lg font-semibold hover:bg-blue-700 shadow-md transition">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏£‡∏π</button>
                <button id="btn-go-student" class="bg-green-600 text-white px-8 py-3 rounded-lg font-semibold hover:bg-green-700 shadow-md transition">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
            </div>
        </div>

        <!-- 2. Teacher Dashboard -->
        <div id="page-teacher-dashboard" class="page w-full bg-white rounded-xl shadow-lg overflow-hidden flex flex-col h-[90vh]">
            <div class="p-4 bg-gray-50 border-b flex flex-wrap justify-between items-center gap-4">
                <div>
                    <h2 class="text-xl font-bold text-blue-800">‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏≠‡∏ö RBA Monitor</h2>
                    <p class="text-sm text-gray-500">‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: <span id="student-count" class="font-bold">0</span> ‡∏Ñ‡∏ô</p>
                </div>
                <div class="flex gap-2">
                    <button id="btn-toggle-system" class="px-4 py-2 rounded text-white text-sm font-bold shadow transition bg-gray-500">Loading...</button>
                    <button onclick="window.location.reload()" class="px-3 py-2 rounded bg-gray-200 hover:bg-gray-300 text-gray-700 text-sm">‡∏≠‡∏≠‡∏Å</button>
                </div>
            </div>

            <!-- Controls -->
            <div class="p-4 bg-white border-b flex flex-wrap gap-4 items-center text-sm">
                <div class="flex items-center gap-2 border-r pr-4">
                    <span class="text-gray-600">‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠:</span>
                    <input type="checkbox" id="toggle-names" class="w-4 h-4 accent-blue-600" checked>
                </div>
                <div class="flex items-center gap-2 border-r pr-4">
                    <span class="text-gray-600 font-bold">‡πÄ‡∏â‡∏•‡∏¢‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö:</span>
                    <input type="checkbox" id="toggle-answers" class="w-5 h-5 accent-green-600"> <!-- Default OFF -->
                </div>
                <div class="flex-1"></div>
                <button id="btn-dl-excel" class="bg-green-600 text-white px-3 py-1.5 rounded hover:bg-green-700">üì• Excel</button>
                <button id="btn-clear-db" class="bg-red-100 text-red-600 px-3 py-1.5 rounded hover:bg-red-200">üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏£‡∏∞‡∏ö‡∏ö</button>
            </div>

            <!-- Grid -->
            <div class="flex-1 overflow-auto p-4 bg-gray-100">
                <div class="bg-white rounded shadow overflow-hidden">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-gray-200 sticky top-0 z-10 text-xs uppercase text-gray-700">
                            <tr>
                                <th class="p-3 border-b w-10 text-center">#</th>
                                <th class="p-3 border-b w-48">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>
                                <th class="p-3 border-b w-24 text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                <th class="p-3 border-b w-16 text-center">%</th>
                                <!-- Q1-Q15 Headers generated by JS -->
                            </tr>
                        </thead>
                        <tbody id="grid-body" class="text-sm divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 3. Student Login -->
        <div id="page-student-login" class="page m-auto bg-white p-8 rounded-xl shadow-lg max-w-md w-full mt-10">
            <h2 class="text-2xl font-bold text-center text-green-700 mb-6">‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏≠‡∏ö</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß</label>
                    <input type="text" id="student-id" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 outline-none text-center text-lg" placeholder="‡πÄ‡∏ä‡πà‡∏ô 66001">
                </div>
                <div id="student-preview" class="hidden bg-green-50 p-3 rounded text-center border border-green-200">
                    <p class="font-bold text-green-800" id="preview-name"></p>
                    <p class="text-xs text-green-600" id="preview-dept"></p>
                </div>
                <button id="btn-student-login" class="w-full bg-green-600 text-white px-4 py-3 rounded-lg font-bold hover:bg-green-700 transition shadow-lg">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö</button>
                <button onclick="location.reload()" class="w-full text-gray-400 text-sm hover:text-gray-600 mt-2">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </div>
        </div>

        <!-- 4. Student Exam (Step-by-Step) -->
        <div id="page-student-exam" class="page m-auto bg-white w-full max-w-2xl rounded-xl shadow-xl overflow-hidden mt-4 flex flex-col h-[85vh]">
            <!-- Header -->
            <div class="bg-green-600 p-4 text-white flex justify-between items-center">
                <div>
                    <h2 class="text-lg font-bold">‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö RBA</h2>
                    <p class="text-xs opacity-80" id="exam-student-info">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
                </div>
                <div class="text-right">
                    <span class="text-2xl font-bold" id="q-current">1</span><span class="text-sm opacity-70">/15</span>
                </div>
            </div>

            <!-- Question Area -->
            <div class="flex-1 p-6 overflow-y-auto flex flex-col justify-center">
                <div id="question-container" class="animate-fade-in">
                    <p class="text-gray-500 text-sm mb-2 uppercase tracking-wide font-bold">‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà <span id="q-num-display">1</span></p>
                    <h3 class="text-xl md:text-2xl font-medium text-gray-800 mb-8 leading-relaxed" id="question-text">...</h3>
                    
                    <div class="space-y-3">
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-green-50 hover:border-green-300 transition group select-none" onclick="selectAnswer(true)">
                            <div class="w-6 h-6 rounded-full border-2 border-gray-300 flex items-center justify-center group-hover:border-green-500 mr-4" id="radio-true"></div>
                            <span class="text-lg font-medium text-gray-700">‡∏ñ‡∏π‡∏Å (True)</span>
                        </label>
                        
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-red-50 hover:border-red-300 transition group select-none" onclick="selectAnswer(false)">
                            <div class="w-6 h-6 rounded-full border-2 border-gray-300 flex items-center justify-center group-hover:border-red-500 mr-4" id="radio-false"></div>
                            <span class="text-lg font-medium text-gray-700">‡∏ú‡∏¥‡∏î (False)</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Navigation -->
            <div class="p-4 bg-gray-50 border-t flex justify-between items-center">
                <button id="btn-prev" class="px-6 py-2 rounded-lg font-medium text-gray-600 hover:bg-gray-200 disabled:opacity-30 disabled:cursor-not-allowed transition" disabled>
                    ‚¨Ö ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö
                </button>
                
                <!-- Dots Indicator (Mini) -->
                <div class="hidden md:flex gap-1">
                    <!-- JS will populate dots -->
                    <div id="mini-dots" class="flex gap-1"></div>
                </div>

                <button id="btn-next" class="px-6 py-2 rounded-lg font-bold bg-blue-600 text-white hover:bg-blue-700 shadow-md transition">
                    ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚û°
                </button>
                
                <button id="btn-submit" class="hidden px-6 py-2 rounded-lg font-bold bg-green-600 text-white hover:bg-green-700 shadow-md transition animate-pulse">
                    ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö ‚úÖ
                </button>
            </div>
        </div>

        <!-- 5. Submitted -->
        <div id="page-submitted" class="page m-auto bg-white p-10 rounded-xl shadow-lg text-center max-w-md mt-10">
            <div class="mb-4 text-6xl">üéâ</div>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!</h2>
            <p class="text-gray-500">‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ö</p>
            <div class="mt-8 pt-6 border-t">
                <button onclick="location.reload()" class="text-blue-600 hover:underline text-sm">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
            </div>
        </div>

    </div>

    <!-- Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, query, enableNetwork, writeBatch, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCr08U5KYGvxXu-DZ5qZOyVnU_1MJ-oY50",
            authDomain: "rba-online-6342e.firebaseapp.com",
            databaseURL: "https://rba-online-6342e-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "rba-online-6342e",
            storageBucket: "rba-online-6342e.firebasestorage.app",
            messagingSenderId: "50383344070",
            appId: "1:50383344070:web:5003afe4c5530fc1d5a2c7",
            measurementId: "G-G75D8551FP"
        };

        const QUESTIONS = [
            { t: "RBA (Responsible Business Alliance) ‡∏Ñ‡∏∑‡∏≠ ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏à‡∏£‡∏£‡∏¢‡∏≤‡∏ö‡∏£‡∏£‡∏ì‡πÅ‡∏´‡πà‡∏á‡∏û‡∏±‡∏ô‡∏ò‡∏°‡∏¥‡∏ï‡∏£‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏ú‡∏π‡πâ‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö", a: true },
            { t: "CORPORATE CODE OF CONDUCT ‡∏Ñ‡∏∑‡∏≠ ‡∏Ç‡πâ‡∏≠‡∏Å‡πç‡∏≤‡∏´‡∏ô‡∏î‡∏î‡πâ‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏¢‡∏ò‡∏£‡∏£‡∏°‡∏ó‡∏≤‡∏á‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏Ç‡∏≠‡∏á‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó", a: true },
            { t: "‡∏Ç‡πâ‡∏≠‡∏Å‡πç‡∏≤‡∏´‡∏ô‡∏î‡∏î‡πâ‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏¢‡∏ò‡∏£‡∏£‡∏° ‡πÄ‡∏õ‡πá‡∏ô‡∏ö‡∏ó‡∏ö‡∏±‡∏ç‡∏ç‡∏±‡∏ï‡∏¥‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏°", a: true },
            { t: "‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏Æ‡∏≤‡∏ô‡∏≤‡∏Ø ‡∏ô‡πç‡∏≤‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á RBA ‡∏°‡∏≤‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏π‡πâ‡∏Ñ‡πâ‡∏≤‡∏Å‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å RBA", a: true },
            { t: "‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Ç‡∏≠‡∏áRBA ‡∏°‡∏µ‡∏ó‡∏±‡∏á‡πâ‡∏´‡∏°‡∏î 5 ‡∏™‡πà‡∏ß‡∏ô ‡∏Ñ‡∏∑‡∏≠ ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡πÅ‡∏£‡∏á‡∏á‡∏≤‡∏ô, ‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢, ‡∏™‡∏¥‡πà‡∏á‡πÅ‡∏ß‡∏î‡∏•‡πâ‡∏≠‡∏°, ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£, ‡∏à‡∏£‡∏¥‡∏¢‡∏ò‡∏£‡∏£‡∏°‡∏ó‡∏≤‡∏á‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à", a: true },
            { t: "‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏Æ‡∏≤‡∏ô‡∏≤‡∏Ø ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏±‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏≠‡∏≤‡∏¢‡∏∏‡∏ï‡πç‡πà‡∏≤‡∏Å‡∏ß‡πà‡∏≤ 18 ‡∏õ‡∏µ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ó‡πç‡∏≤‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πâ‡∏ú‡∏¥‡∏î‡∏à‡∏£‡∏£‡∏¢‡∏≤‡∏ö‡∏£‡∏£‡∏ì", a: false },
            { t: "‡πÅ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏£‡πâ‡∏°‡∏ô‡∏∏‡∏©‡∏¢‡∏ò‡∏£‡∏£‡∏° ‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏π‡πà‡πÄ‡∏Ç‡πá‡∏ç‡∏ó‡∏≤‡∏á‡∏à‡∏¥‡∏ï‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢ ‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏ß‡∏á‡∏•‡∏∞‡πÄ‡∏°‡∏¥‡∏î‡∏ó‡∏≤‡∏á‡πÄ‡∏û‡∏® ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏•‡∏∞‡πÄ‡∏°‡∏¥‡∏î‡∏î‡πâ‡∏ß‡∏¢‡∏ß‡∏≤‡∏à‡∏≤‡∏ï‡πà‡∏≠‡πÅ‡∏£‡∏á‡∏á‡∏≤‡∏ô", a: true },
            { t: "‡∏´‡∏≤‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏™‡∏†‡∏≤‡∏û‡∏™‡∏¥‡πà‡∏á‡πÅ‡∏ß‡∏î‡∏•‡πâ‡∏≠‡∏°‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Å‡πá‡∏°‡∏µ‡∏Ç‡∏ß‡∏±‡∏ç‡πÅ‡∏•‡∏∞‡∏Å‡πç‡∏≤‡∏•‡∏±‡∏á‡πÉ‡∏à‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡πç‡∏≤‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏™‡πà‡∏á‡∏ú‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏Ç‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏°‡∏µ‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô", a: true },
            { t: "‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÉ‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô ‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ú‡∏•", a: true },
            { t: "‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏¢‡∏∂‡∏î‡∏ñ‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏°‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢ ‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏Å‡πç‡∏≤‡∏´‡∏ô‡∏î‡∏Ç‡∏≠‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏´‡πâ‡∏≤‡∏°‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏à‡πç‡∏≤‡∏Å‡∏±‡∏î‡∏™‡∏≤‡∏£‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÉ‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï ‡πÄ‡∏ä‡πà‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå RoHS", a: true },
            { t: "‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏¥‡∏î‡∏™‡∏¥‡∏ô‡∏ö‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö ‡∏´‡∏≤‡∏Å‡∏ó‡πç‡∏≤‡πÉ‡∏´‡πâ‡∏á‡∏≤‡∏ô‡∏™‡πç‡∏≤‡πÄ‡∏£‡πá‡∏à‡∏•‡∏∏‡∏•‡πà‡∏ß‡∏á‡πÑ‡∏õ‡πÑ‡∏î‡πâ", a: false },
            { t: "‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏ú‡∏•‡∏¥‡∏ï,‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏á‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤", a: true },
            { t: "‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ñ‡∏≤‡∏£‡∏û‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏õ‡∏±‡∏ç‡∏ç‡∏≤‡∏Ç‡∏≠‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ‡πÇ‡∏î‡∏¢‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÅ‡∏≠‡∏ö‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏´‡∏£‡∏∑‡∏≠‡∏ô‡πç‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÑ‡∏õ‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà‡πÇ‡∏î‡∏¢‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏ú‡∏¥‡∏î‡∏Å‡∏è‡∏´‡∏°‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏ñ‡∏π‡∏Å‡∏•‡∏á‡πÇ‡∏ó‡∏©", a: true },
            { t: "‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡πç‡∏≤‡πÄ‡∏ô‡∏¥‡∏ô‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏Ç‡∏≠‡∏á‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß", a: true },
            { t: "‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏Æ‡∏≤‡∏ô‡∏≤‡∏Ø ‡∏°‡∏µ‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô‡∏Å‡∏≤‡∏£‡∏°‡∏µ‡∏™‡πà‡∏ß‡∏ô‡∏£‡πà‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡∏ä‡∏∏‡∏°‡∏ä‡∏ô ‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏ó‡∏≤‡∏á‡∏™‡∏±‡∏á‡∏Ñ‡∏° ‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ó‡∏≤‡∏á‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡πÅ‡∏•‡∏∞‡πÄ‡∏®‡∏£‡∏©‡∏ê‡∏Å‡∏¥‡∏à‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏°‡πÅ‡∏Ç‡πá‡∏á", a: true }
        ];

        const TEACHER_CODE = "RBA";
        const SHEET_URL = "https://docs.google.com/spreadsheets/d/163RszY_6sDDQXxWiPlkw7g5HCj_U4N49H7CMCmzWPEw/export?format=csv&gid=0";

        let db, auth;
        let currentStudent = null;
        let studentCache = null;
        let examState = {
            currentIdx: 0,
            answers: new Array(QUESTIONS.length).fill(null) // [null, true, false, null...]
        };
        let allResults = [];
        let showAnswers = false;
        let showNames = true;

        // Refs
        let configRef, studentsRef;

        // --- INIT ---
        async function init() {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            configRef = doc(db, 'rba_system_config', 'main');
            studentsRef = collection(db, 'rba_students');

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    document.getElementById('loading-overlay').style.display = 'none';
                } else {
                    signInAnonymously(auth).catch(e => alert("Auth Error: " + e.message));
                }
            });
        }

        // --- NAVIGATION ---
        const show = (id) => {
            document.querySelectorAll('.page').forEach(el => el.style.display = 'none');
            document.getElementById(id).style.display = 'flex'; // Use flex for centered pages
            // Reset specifics
            if(id === 'page-teacher-dashboard') document.getElementById(id).style.display = 'block';
            if(id === 'page-student-exam') document.getElementById(id).style.display = 'flex';
        };

        document.getElementById('btn-go-teacher').onclick = () => show('page-teacher-login');
        document.getElementById('btn-go-student').onclick = () => show('page-student-login');

        // --- TEACHER SYSTEM ---
        document.getElementById('btn-teacher-login').onclick = () => {
            if(document.getElementById('teacher-room-code').value === TEACHER_CODE) {
                show('page-teacher-dashboard');
                initTeacherDashboard();
            } else {
                alert("‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏¥‡∏î");
            }
        };

        function initTeacherDashboard() {
            // Setup Grid Headers
            const thead = document.querySelector('thead tr');
            // Clear Q cols
            while(thead.children.length > 4) thead.removeChild(thead.lastChild);
            
            QUESTIONS.forEach((_, i) => {
                const th = document.createElement('th');
                th.className = "p-2 border-b text-center w-10 font-bold text-gray-500";
                th.innerText = i + 1;
                thead.appendChild(th);
            });

            // Listeners
            onSnapshot(configRef, (snap) => {
                const isOpen = snap.exists() ? snap.data().isOpen : false;
                const btn = document.getElementById('btn-toggle-system');
                btn.textContent = isOpen ? "üî¥ ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö" : "üü¢ ‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö";
                btn.className = isOpen ? "px-4 py-2 rounded text-white text-sm font-bold shadow transition bg-red-500 hover:bg-red-600" : "px-4 py-2 rounded text-white text-sm font-bold shadow transition bg-green-500 hover:bg-green-600";
                
                btn.onclick = async () => {
                    await setDoc(configRef, { isOpen: !isOpen });
                };
            });

            onSnapshot(query(studentsRef), (snap) => {
                allResults = [];
                snap.forEach(d => allResults.push(d.data()));
                renderGrid();
            });

            document.getElementById('toggle-answers').onchange = (e) => { showAnswers = e.target.checked; renderGrid(); };
            document.getElementById('toggle-names').onchange = (e) => { showNames = e.target.checked; renderGrid(); };
        }

        function renderGrid() {
            const tbody = document.getElementById('grid-body');
            tbody.innerHTML = '';
            document.getElementById('student-count').innerText = allResults.length;

            // Sort: Submitted first, then by ID
            allResults.sort((a,b) => (b.status === 'submitted' ? 1 : 0) - (a.status === 'submitted' ? 1 : 0));

            allResults.forEach((s, i) => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50 transition";

                // 1. Index
                tr.innerHTML += `<td class="p-3 border-b text-center text-gray-400">${i+1}</td>`;
                
                // 2. Name
                const nameClass = s.status === 'online' ? "text-blue-600 font-medium animate-pulse" : "text-gray-800 font-medium";
                const displayName = showNames ? s.name : `Student ${s.studentId.slice(-3)}`;
                tr.innerHTML += `<td class="p-3 border-b"><div class="${nameClass}">${displayName}</div><div class="text-xs text-gray-400">${s.dept}</div></td>`;

                // 3. Status
                let statusBadge = "";
                if(s.status === 'submitted') statusBadge = `<span class="px-2 py-1 rounded-full bg-green-100 text-green-700 text-xs font-bold">‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß</span>`;
                else if (s.status === 'online') statusBadge = `<span class="px-2 py-1 rounded-full bg-blue-100 text-blue-700 text-xs font-bold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥..</span>`;
                tr.innerHTML += `<td class="p-3 border-b text-center">${statusBadge}</td>`;

                // 4. Score
                const scoreDisplay = s.score !== null ? `${s.score}%` : "-";
                tr.innerHTML += `<td class="p-3 border-b text-center font-bold text-gray-700">${scoreDisplay}</td>`;

                // 5. Questions Grid (Realtime Dots)
                s.answers.forEach((ans, idx) => {
                    let cellClass = "w-6 h-6 rounded-full mx-auto border flex items-center justify-center text-[10px] font-bold transition-all duration-300 ";
                    let content = "";

                    if (ans === null) {
                        // Not done yet
                        cellClass += "bg-gray-100 border-gray-200";
                    } else {
                        // Answered
                        if (showAnswers) {
                            // Show Right/Wrong
                            const isCorrect = ans === QUESTIONS[idx].a;
                            if(isCorrect) {
                                cellClass += "bg-green-500 border-green-600 text-white scale-110 shadow-sm";
                                content = "‚úì";
                            } else {
                                cellClass += "bg-red-500 border-red-600 text-white scale-110 shadow-sm";
                                content = "‚úï";
                            }
                        } else {
                            // Hidden (Show Progress)
                            cellClass += "bg-blue-500 border-blue-600 text-white";
                        }
                    }
                    
                    tr.innerHTML += `<td class="p-2 border-b"><div class="${cellClass}">${content}</div></td>`;
                });

                tbody.appendChild(tr);
            });
        }

        // --- EXCEL ---
        document.getElementById('btn-dl-excel').onclick = () => {
            if(allResults.length === 0) return alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
            const data = allResults.map((s, i) => {
                const row = {
                    "‡∏•‡∏≥‡∏î‡∏±‡∏ö": i+1,
                    "‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô": s.studentId,
                    "‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•": s.name,
                    "‡πÅ‡∏ú‡∏ô‡∏Å": s.dept, // Added Dept
                    "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞": s.status,
                    "‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (%)": s.score || 0,
                    "‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ (‡∏ß‡∏¥)": s.timeTaken ? s.timeTaken.toFixed(0) : '-'
                };
                
                // Add Q1-Q15 details
                s.answers.forEach((ans, idx) => {
                    let res = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ó‡∏≥";
                    if(ans !== null) {
                        res = (ans === QUESTIONS[idx].a) ? "‡∏ñ‡∏π‡∏Å" : "‡∏ú‡∏¥‡∏î";
                    }
                    row[`‡∏Ç‡πâ‡∏≠ ${idx+1}`] = res;
                });
                
                return row;
            });
            
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Exam Results");
            XLSX.writeFile(wb, `RBA_Report_${new Date().toLocaleDateString()}.xlsx`);
        };

        document.getElementById('btn-clear-db').onclick = async () => {
            if(confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?")) {
                const batch = writeBatch(db);
                const snap = await getDocs(studentsRef);
                snap.forEach(d => batch.delete(d.ref));
                await batch.commit();
                // Reset Config
                await setDoc(configRef, { isOpen: false });
                alert("‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
            }
        };

        // --- STUDENT SYSTEM ---
        async function fetchStudents() {
            if(studentCache) return studentCache;
            try {
                const res = await fetch(SHEET_URL);
                const csv = await res.text();
                return new Promise(r => Papa.parse(csv, {header:true, skipEmptyLines:true, complete: res=>r(res.data)}));
            } catch(e) { return []; }
        }

        document.getElementById('student-id').addEventListener('input', async (e) => {
            const id = e.target.value.trim();
            const box = document.getElementById('student-preview');
            if(id.length < 3) { box.classList.add('hidden'); return; }
            
            const list = await fetchStudents();
            const s = list.find(x => x['‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß'] == id);
            if(s) {
                document.getElementById('preview-name').innerText = `${s['‡∏ä‡∏∑‡πà‡∏≠']} ${s['‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•']}`;
                document.getElementById('preview-dept').innerText = s['‡πÅ‡∏ú‡∏ô‡∏Å'];
                box.classList.remove('hidden');
                studentCache = list; // Cache it
            } else {
                box.classList.add('hidden');
            }
        });

        document.getElementById('btn-student-login').onclick = async () => {
            const id = document.getElementById('student-id').value.trim();
            if(!id) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™");

            // Checks
            const conf = await getDoc(configRef);
            if(!conf.exists() || !conf.data().isOpen) return alert("‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î");
            
            const list = await fetchStudents();
            const s = list.find(x => x['‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß'] == id);
            if(!s) return alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô");

            // Init User Data
            currentStudent = { 
                id: s['‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß'], 
                name: `${s['‡∏ä‡∏∑‡πà‡∏≠']} ${s['‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•']}`, 
                dept: s['‡πÅ‡∏ú‡∏ô‡∏Å'],
                startTime: Date.now() 
            };

            // ** REALTIME: Create Initial Record immediately **
            const existing = await getDoc(doc(studentsRef, currentStudent.id));
            if(existing.exists() && existing.data().status === 'submitted') return alert("‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≠‡∏ö‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß");
            
            if(!existing.exists()) {
                 await setDoc(doc(studentsRef, currentStudent.id), {
                    studentId: currentStudent.id,
                    name: currentStudent.name,
                    dept: currentStudent.dept,
                    status: 'online',
                    score: null,
                    answers: new Array(QUESTIONS.length).fill(null),
                    currentQ: 0
                });
            } else {
                // Restore session if re-login
                examState.answers = existing.data().answers;
                examState.currentIdx = existing.data().currentQ || 0;
            }

            // UI Setup
            document.getElementById('exam-student-info').innerText = `${currentStudent.name} (${currentStudent.dept})`;
            setupMiniDots();
            renderQuestion();
            show('page-student-exam');
        };

        function setupMiniDots() {
            const c = document.getElementById('mini-dots');
            c.innerHTML = '';
            QUESTIONS.forEach((_, i) => {
                const d = document.createElement('div');
                d.id = `dot-${i}`;
                d.className = "w-2 h-2 rounded-full bg-gray-300 transition";
                c.appendChild(d);
            });
        }

        function renderQuestion() {
            const idx = examState.currentIdx;
            const q = QUESTIONS[idx];
            
            // Update UI
            document.getElementById('q-current').innerText = idx + 1;
            document.getElementById('q-num-display').innerText = idx + 1;
            document.getElementById('question-text').innerText = q.t;
            
            // Buttons Logic
            document.getElementById('btn-prev').disabled = idx === 0;
            if(idx === QUESTIONS.length - 1) {
                document.getElementById('btn-next').classList.add('hidden');
                document.getElementById('btn-submit').classList.remove('hidden');
            } else {
                document.getElementById('btn-next').classList.remove('hidden');
                document.getElementById('btn-submit').classList.add('hidden');
            }

            // Restore selection
            const val = examState.answers[idx];
            resetRadio('radio-true');
            resetRadio('radio-false');
            if(val === true) setRadio('radio-true', 'green');
            if(val === false) setRadio('radio-false', 'red');
            
            // Update Mini Dots
            QUESTIONS.forEach((_, i) => {
                const d = document.getElementById(`dot-${i}`);
                if(i === idx) d.className = "w-3 h-3 rounded-full bg-blue-600 ring-2 ring-blue-200"; // Active
                else if (examState.answers[i] !== null) d.className = "w-2 h-2 rounded-full bg-blue-400"; // Answered
                else d.className = "w-2 h-2 rounded-full bg-gray-300"; // Empty
            });
        }

        window.selectAnswer = async (val) => {
            const idx = examState.currentIdx;
            examState.answers[idx] = val;
            
            // Visual
            resetRadio('radio-true'); resetRadio('radio-false');
            if(val === true) setRadio('radio-true', 'green');
            if(val === false) setRadio('radio-false', 'red');

            // ** REALTIME SYNC **
            // Debounce slightly in prod, but direct here for responsiveness
            updateDoc(doc(studentsRef, currentStudent.id), {
                answers: examState.answers,
                currentQ: idx
            });
        };

        function setRadio(id, color) {
            const el = document.getElementById(id);
            el.innerHTML = `<div class="w-3 h-3 bg-${color}-500 rounded-full"></div>`;
            el.className = `w-6 h-6 rounded-full border-2 flex items-center justify-center mr-4 border-${color}-500`;
            el.parentElement.className = `flex items-center p-4 border-2 rounded-lg cursor-pointer transition group select-none border-${color}-200 bg-${color}-50`;
        }
        
        function resetRadio(id) {
            const el = document.getElementById(id);
            el.innerHTML = '';
            el.className = `w-6 h-6 rounded-full border-2 border-gray-300 flex items-center justify-center mr-4`;
            el.parentElement.className = `flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition group select-none`;
        }

        document.getElementById('btn-prev').onclick = () => {
            if(examState.currentIdx > 0) {
                examState.currentIdx--;
                renderQuestion();
            }
        };

        document.getElementById('btn-next').onclick = () => {
            if(examState.answers[examState.currentIdx] === null) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡∏Ç‡πâ‡∏≠‡∏ñ‡∏±‡∏î‡πÑ‡∏õ");
            if(examState.currentIdx < QUESTIONS.length - 1) {
                examState.currentIdx++;
                renderQuestion();
                // Update remote currentQ marker
                updateDoc(doc(studentsRef, currentStudent.id), { currentQ: examState.currentIdx });
            }
        };

        document.getElementById('btn-submit').onclick = async () => {
            if(examState.answers[examState.currentIdx] === null) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢");
            if(!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö?")) return;

            let score = 0;
            examState.answers.forEach((a, i) => { if(a === QUESTIONS[i].a) score++; });
            const finalScore = (score / QUESTIONS.length) * 100;

            await updateDoc(doc(studentsRef, currentStudent.id), {
                answers: examState.answers,
                score: finalScore,
                status: 'submitted',
                timeTaken: (Date.now() - currentStudent.startTime) / 1000
            });

            show('page-submitted');
        };

        // Start
        init();
    </script>
</body>
</html>